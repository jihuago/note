## Redis主从，如何实现数据一致
## 主从配置
有实例1 ip(172.16.19.3)、实例2 ip(172.16.19.5)，在实例2上执行以下命令，实例2就变成了实例1的从库

```
replicaof 172.16.19.3 6379
```

### redis主从库数据第一次同步的三个阶段
![](../images/主从库第一次同步的流程.jpg)

* 第一阶段：建立连接
主从库建立连接、协商同步的过程，主要是为全量复制做准备。从库与主库建立连接，并告诉主库即将进行同步，主库确认回复后，主从库间就可以开始同步了
  
具体来说，从库给主库发送psync命令，表示要进行数据同步，主库根据整个命令的参数来启动复制。

* 第二阶段：同步RDB文件
主库将所有数据同步给从库。从库手动数据后，在本地完成数据加载。整个过程依赖于内存快照生成的RDB文件。
具体地说，主库执行bgsave命令，生成RDB文件，接着将文件发给从库。从库接受到RDB文件后，会先清空当前数据库，然后加载RDB文件。
  
在主库将数据同步给从库的过程中，主库不会被阻塞，依然可以正常接受请求。但是这些请求中的写操作并没有记录到刚刚生成的RDB文件找那个。
为了保证主从库的数据一致性，主库会在内存中用专门的replication buffer，记录RDB文件生成后收到的所有写操作。

* 第三阶段：同步增量数据
主库会把第二阶段执行过程中新收到的写命令，再发送给从库。具体的操作是，当主库完成RDB文件发送后，就会把此时replication buffer中的修改
操作发给从库，从库再重新执行这些操作。
  
### 主从级联模式
一次全量复制中，对于主库来说，需要完成两个耗时的操作：生成RDB文件和传输RDB文件。
通过“主-从-从”模式将主库生成RDB和传输RDB的压力，以级联的方式分散到从库上。

* 基于长连接的命令传播
一旦主从库完成了全量复制，它们之间就会一直维护一个网络连接，主库会通过这个链接将后续连续收到的命令操作再同步给从库，这个过程称为基于长连接的命令传播
可以避免频繁建立连接的开销。
  
### 主从库间网络断了怎么办
从Redis2.8开始，网络断了之后，主从库会采用增量复制的方式继续同步。
* 增量复制
当主从断连后，主库会把断连期间收到的写操作命令，写入repl_backlog_buffer缓冲区。
repl_backlog_buffer是一个环形缓冲区，所以在缓冲区写满后，主库会继续写入，此时，就会覆盖之前写入的操作。  
  
如果从库的读取速度比较慢，就有可能导致从库还未读取的操作被主库新写的操作覆盖了，这回导致主从库间的数据不一致。

通过调整repl_backlog_size这个参数来避免从库还未读取的操作被主库新写的操作覆盖。
缓存空间大小 = 主库写入命令速度 * 操作大小 - 主从库间网络传输命令速度 * 操作大小
在实际应用中，考虑到存在一些突发的请求压力，通常将缓存空间扩大一倍。

### 实用建议
* 一个Redis实例的数据不要太大
    大小在几GB级别比较合适，这样可以减少RDB文件生成、传输和重新加载的开销
* 采用主-从-从级联模式

    